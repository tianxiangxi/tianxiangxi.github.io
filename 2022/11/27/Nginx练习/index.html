

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="Nginx[TOC] 一、Nginx的编译安装1.1、官方源码包下载地址：1https:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;download.html   1.2、编译安装123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx练习">
<meta property="og:url" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/index.html">
<meta property="og:site_name" content="5-12 23:30">
<meta property="og:description" content="Nginx[TOC] 一、Nginx的编译安装1.1、官方源码包下载地址：1https:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;download.html   1.2、编译安装123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221127110618803.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221127114404902.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221127155647389.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221128112020141.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221128113152131.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221128151842453.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221128155842696.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221128163638945.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221129131337835.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221130102253614.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221130103145411.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221130105907996.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221130115618073.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221130122042043.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221130122106468.png">
<meta property="og:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221130141246807.png">
<meta property="article:published_time" content="2022-11-27T10:22:35.000Z">
<meta property="article:modified_time" content="2022-12-18T04:04:09.180Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2022/11/27/Nginx%E7%BB%83%E4%B9%A0/image-20221127110618803.png">
  
  
  <title>Nginx练习 - 5-12 23:30</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Nginx练习">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-11-27 10:22" pubdate>
        November 27, 2022 am
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      36k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      301 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Nginx练习</h1>
            
            <div class="markdown-body">
              <h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><p>[TOC]</p>
<h3 id="一、Nginx的编译安装"><a href="#一、Nginx的编译安装" class="headerlink" title="一、Nginx的编译安装"></a>一、Nginx的编译安装</h3><h4 id="1-1、官方源码包下载地址："><a href="#1-1、官方源码包下载地址：" class="headerlink" title="1.1、官方源码包下载地址："></a>1.1、官方源码包下载地址：</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs ABAP">https://nginx.org/en/download.html<br></code></pre></td></tr></table></figure>

<p><a href=""><img src="image-20221127110618803.png" srcset="/img/loading.gif" lazyload alt="image-20221127110618803"></a></p>
<h4 id="1-2、编译安装"><a href="#1-2、编译安装" class="headerlink" title="1.2、编译安装"></a>1.2、编译安装</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky ~]<span class="hljs-comment">#yum -y install gcc pcre-devel openssl-devel zlib-devel     #安装相关包</span><br>[root@Rocky ~]<span class="hljs-comment">#useradd -s /sbin/nologin nginx          #创建Nginx账号，因不需要登录，只需要给nologin的shell类型</span><br>[root@Rocky ~]<span class="hljs-comment">#wget https://nginx.org/download/nginx-1.22.1.tar.gz</span><br>[root@Rocky ~]<span class="hljs-comment">#mv nginx-1.22.1.tar.gz  /usr/local/src</span><br><span class="hljs-comment">#/usr/local ：用户级的软件目录，用来存放用户安装编译的软件，用户自己编译安装的软件也默认存放在这里</span><br><span class="hljs-comment">#/usr/local/src ：这个目录是存放用户编译软件所用的源码的</span><br>[root@Rocky ~]<span class="hljs-comment">#cd /usr/local/src</span><br>[root@Rocky src]<span class="hljs-comment">#tar xf nginx-1.22.1.tar.gz </span><br>[root@Rocky src]<span class="hljs-comment">#ls</span><br>nginx-1.22.1  nginx-1.22.1.tar.gz<br>[root@Rocky src]<span class="hljs-comment">#cd nginx-1.22.1/</span><br>[root@Rocky nginx-1.22.1]<span class="hljs-comment">#ls</span><br>auto  CHANGES  CHANGES.ru  conf  configure  contrib  html  LICENSE  man  README  src<br><span class="hljs-comment">#一般安装方法可以从README或者INSTALL里面可以找到</span><br>[root@Rocky nginx-1.22.1]<span class="hljs-comment">#./configure --prefix=/apps/nginx \</span><br>--user=nginx \<br>--group=nginx \<br>--with-http_ssl_module \<br>--with-http_v2_module \<br>--with-http_realip_module \<br>--with-http_stub_status_module \<br>--with-http_gzip_static_module \<br>--with-pcre \<br>--with-stream \<br>--with-stream_ssl_module \<br>--with-stream_realip_module<br>[root@Rocky nginx-1.22.1]<span class="hljs-comment">#make -j 2 &amp;&amp; make install</span><br>[root@Rocky ~]<span class="hljs-comment">#tree /apps/nginx</span><br>/apps/nginx<br>├── conf<br>│   ├── fastcgi.conf<br>│   ├── fastcgi.conf.default<br>│   ├── fastcgi_params<br>│   ├── fastcgi_params.default<br>│   ├── koi-utf<br>│   ├── koi-win<br>│   ├── mime.types<br>│   ├── mime.types.default<br>│   ├── nginx.conf<br>│   ├── nginx.conf.default<br>│   ├── scgi_params<br>│   ├── scgi_params.default<br>│   ├── uwsgi_params<br>│   ├── uwsgi_params.default<br>│   └── win-utf<br>├── html<br>│   ├── 50x.html<br>│   └── index.html<br>├── logs<br>└── sbin<br>    └── nginx<br>[root@Rocky ~]<span class="hljs-comment">#/apps/nginx/sbin/nginx          #启动Nginx，后台启动</span><br>[root@Rocky ~]<span class="hljs-comment">#ss -ntl                         #此时可以看到80端口已监听</span><br>State   Recv-Q   Send-Q     Local Address:Port      Peer Address:Port        Process <br>LISTEN  0        128        0.0.0.0:80              0.0.0.0:*                       <br>LISTEN  0        128        0.0.0.0:22              0.0.0.0:*                       <br>LISTEN  0        128        [::]:22                 [::]:*<br><span class="hljs-comment">#此时关闭只有使用kill命令</span><br>[root@Rocky ~]<span class="hljs-comment">#ps auxf</span><br>root       29907  0.0  0.0  42572   848 ?        Ss   12:05   0:00 nginx: master process /apps/ngin<br>nginx      29908  0.0  0.2  74680  4948 ?        S    12:05   0:00  \_ nginx: worker process<br>[root@Rocky ~]<span class="hljs-comment">#kill 29907</span><br><br><span class="hljs-comment">#只输入Nginx就可以启动有两种方法</span><br><span class="hljs-comment">#第一种方法</span><br>[root@Rocky ~]<span class="hljs-comment">#ln -s /apps/nginx/sbin/nginx /usr/sbin/</span><br>[root@Rocky ~]<span class="hljs-comment">#nginx</span><br>[root@Rocky ~]<span class="hljs-comment">#ss -ntl</span><br>State    Recv-Q     Send-Q     Local Address:Port     Peer Address:Port     Process <br>LISTEN     0          128       0.0.0.0:80                 0.0.0.0:*                 <br>LISTEN     0          128       0.0.0.0:22                 0.0.0.0:*                 <br>LISTEN     0          128       [::]:22                    [::]:*                   <br>[root@Rocky ~]<span class="hljs-comment">#nginx -s stop</span><br>[root@Rocky ~]<span class="hljs-comment">#ss -ntl</span><br>State    Recv-Q     Send-Q      Local Address:Port     Peer Address:Port     Process <br>LISTEN     0          128        0.0.0.0:22                 0.0.0.0:*               <br>LISTEN     0          128        [::]:22                    [::]:*                   <br><span class="hljs-comment">#第二种方法</span><br>[root@Rocky ~]<span class="hljs-comment">#echo &quot;PATH=/apps/nginx/sbin:$PATH&quot; &gt; /etc/profile.d/nginx.sh</span><br><span class="hljs-comment">#将其路径写入环境变量中</span><br>[root@Rocky ~]<span class="hljs-comment">#source  /etc/profile.d/nginx.sh</span><br><br></code></pre></td></tr></table></figure>

<p><a href=""><img src="image-20221127114404902.png" srcset="/img/loading.gif" lazyload alt="image-20221127114404902"></a></p>
<h4 id="1-3、设置启动方式"><a href="#1-3、设置启动方式" class="headerlink" title="1.3、设置启动方式"></a>1.3、设置启动方式</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#使用nginx此种方式开启，关闭时只能使用kill</span><br><span class="hljs-comment">#更好的方式是设置service文件</span><br>[root@Rocky ~]<span class="hljs-comment">#vim /usr/lib/systemd/system/nginx.service</span><br>[Unit]<br>Description=nginx - high performance web server<br>Documentation=http://nginx.org/en/docs/<br>After=network-online.target remote-fs.target nss-lookup.target<br>Wants=network-online.target<br><br>[Service]<br>Type=forking<br>PIDFile=/apps/nginx/run/nginx.pid         <span class="hljs-comment">#指定pid文件的目录,默认在logs目录下,可选配置</span><br>ExecStart=/apps/nginx/sbin/nginx -c /apps/nginx/conf/nginx.conf<br>ExecReload=/bin/kill -s HUP <span class="hljs-variable">$MAINPID</span>      <span class="hljs-comment">#$MAINPID指的是主进程的pid</span><br>ExecStop=/bin/kill -s TERM <span class="hljs-variable">$MAINPID</span><br>LimitNOFILE=100000<br><br>[Install]<br>WantedBy=multi-user.target<br>:wq<br><span class="hljs-comment">#需要自己创建存放pid的文件目录</span><br>[root@Rocky ~]<span class="hljs-comment">#mkdir /apps/nginx/run</span><br><span class="hljs-comment">#因为配置文件不知道在哪读取pid，所以需要在配置文件了进行设置</span><br>[root@Rocky ~]<span class="hljs-comment">#vim /apps/nginx/conf/nginx.conf</span><br>pid   /apps/nginx/run/nginx.pid;           <span class="hljs-comment">#取消此行注释，并将路径改为此路径</span><br>:wq<br><span class="hljs-comment">#注意修改完配置文件后，需先查看是否有语法错误：nginx -t</span><br>[root@Rocky ~]<span class="hljs-comment">#systemctl enable --now nginx</span><br>Created symlink /etc/systemd/system/multi-user.target.wants/nginx.service → /usr/lib/systemd/system/nginx.service.<br>[root@Rocky ~]<span class="hljs-comment">#ss -ntl</span><br>State    Recv-Q     Send-Q     Local Address:Port     Peer Address:Port     Process <br>LISTEN     0          128           0.0.0.0:80           0.0.0.0:*     <br>LISTEN     0          128           0.0.0.0:22           0.0.0.0:*     <br>LISTEN     0          128           [::]:22              [::]:*  <br><br></code></pre></td></tr></table></figure>

<h3 id="二、Nginx的平滑升级"><a href="#二、Nginx的平滑升级" class="headerlink" title="二、Nginx的平滑升级"></a>二、Nginx的平滑升级</h3><h4 id="2-1、平滑升级的流程"><a href="#2-1、平滑升级的流程" class="headerlink" title="2.1、平滑升级的流程"></a>2.1、平滑升级的流程</h4><p><a href=""><img src="image-20221127155647389.png" srcset="/img/loading.gif" lazyload alt="image-20221127155647389"></a></p>
<p>①将旧Nginx二进制文件换成新Nginx程序文件（注意先备份) </p>
<p>②向master进程发送USR2信号启动新nginx进程</p>
<p>③master进程修改pid文件名加上后缀.oldbin,成为nginx.pid.oldbin</p>
<p>④master进程用新Nginx文件启动新master进程及worker子进程成为旧master的子进程,系统中将有新旧两个Nginx主进程和对应的worker子进程并存</p>
<p>当前新的请求仍然由旧Nginx的worker进程进行处理,将新生成的master进程的PID存放至新生成的pid文件nginx.pid</p>
<p>⑤向旧的Nginx服务进程发送WINCH信号，使旧的Nginx worker进程平滑停止</p>
<p>⑥向旧master进程发送QUIT信号，关闭旧master，并删除Nginx.pid.oldbin文件</p>
<p>⑦如果发现升级有问题,可以回滚∶向旧master发送HUP，向新master发送QUIT</p>
<h4 id="2-2、将旧Nginx二进制文件换成新Nginx程序文件"><a href="#2-2、将旧Nginx二进制文件换成新Nginx程序文件" class="headerlink" title="2.2、将旧Nginx二进制文件换成新Nginx程序文件"></a>2.2、将旧Nginx二进制文件换成新Nginx程序文件</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#升级前首先需要将原有的复制保存</span><br>[root@Rocky ~]<span class="hljs-comment">#cp /apps/nginx/sbin/nginx   /opt/         #将旧版本复制到opt目录下</span><br><br>[root@Rocky ~]<span class="hljs-comment">#wget https://nginx.org/download/nginx-1.23.2.tar.gz   #下载新版本</span><br>[root@Rocky ~]<span class="hljs-comment">#tar xf nginx-1.23.2.tar.gz                            #解压缩</span><br>[root@Rocky ~]<span class="hljs-comment">#ls</span><br>anaconda-ks.cfg  nginx-1.23.2  nginx-1.23.2.tar.gz<br>[root@Rocky ~]<span class="hljs-comment">#cd nginx-1.23.2/</span><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#nginx -V                       #查看已安装的Nginx的配置</span><br>nginx version: nginx/1.22.1<br>built by gcc 8.5.0 20210514 (Red Hat 8.5.0-10) (GCC) <br>built with OpenSSL 1.1.1k  FIPS 25 Mar 2021<br>TLS SNI support enabled<br>configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module<br><span class="hljs-comment">#configure arguments后面是以前编译时的参数。现在编译使用一样的参数</span><br><br><span class="hljs-comment">#开始编译新版本</span><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module</span><br><span class="hljs-comment">#如果想添加其他配置，也可以添加进去</span><br><br><span class="hljs-comment">#只要make无需要make install</span><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#make -j 2</span><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#ls               #编译完成后，多了objs文件，里面有新版的nginx</span><br>auto  CHANGES  CHANGES.ru  conf  configure  contrib  html  LICENSE  Makefile  man  objs  README  src<br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#objs/nginx -V</span><br>nginx version: nginx/1.23.2<br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#ll objs/nginx  /apps/nginx/sbin/nginx</span><br>-rwxr-xr-x 1 root root 7587600 Nov 27 16:56 /apps/nginx/sbin/nginx<br>-rwxr-xr-x 1 root root 7630304 Nov 27 17:11 objs/nginx<br><br><span class="hljs-comment">#为了便于观察用其他机器下载Nginx的文件</span><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#dd if=/dev/zero of=/apps/nginx/html/fi.img bs=1M count=100</span><br><span class="hljs-comment">#先在Nginx里创建一个100M文件</span><br>[root@centos ~]<span class="hljs-comment">#wget --limit-rate=1024 http://10.0.0.185/fi.img</span><br>[root@centos ~]<span class="hljs-comment">#curl -I 10.0.0.185</span><br>HTTP/1.1 200 OK<br>Server: nginx/1.22.1<br><br><span class="hljs-comment">#将旧版Nginx替换为新版Nginx</span><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#cp -f objs/nginx /apps/nginx/sbin/</span><br><span class="hljs-built_in">cp</span>: overwrite <span class="hljs-string">&#x27;/apps/nginx/sbin/nginx&#x27;</span>? y<br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#ll /apps/nginx/sbin/nginx</span><br>-rwxr-xr-x 1 nginx nginx 7630280 Nov 27 16:21 /apps/nginx/sbin/nginx<br>[root@centos ~]<span class="hljs-comment">#curl -I 10.0.0.185            #替换之后仍是老版本</span><br>HTTP/1.1 200 OK<br>Server: nginx/1.22.1<br><br><span class="hljs-comment">#注意此时只是把磁盘文件里的Nginx替换了，内存里的仍旧是旧版Nginx</span><br><span class="hljs-comment">#下一步首先需要检测新版Nginx和配置文件是否兼容</span><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#/apps/nginx/sbin/nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br><span class="hljs-comment">#显示successful，表示语法兼容</span><br><br></code></pre></td></tr></table></figure>

<h4 id="2-3、向master进程发送USR2信号启动新nginx进程"><a href="#2-3、向master进程发送USR2信号启动新nginx进程" class="headerlink" title="2.3、向master进程发送USR2信号启动新nginx进程"></a>2.3、向master进程发送USR2信号启动新nginx进程</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#发送信号前，只有1个work子进程</span><br>[root@Rocky ~]<span class="hljs-comment">#ps auxf | grep nginx</span><br>root   33042  0.0  0.0  42584   852 ?   Ss  16:31   0:00 nginx: master process nginx<br>nginx  33043  0.0  0.2  74692  4932 ?   S   16:31   0:00  \_ nginx: worker process<br><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#kill -USR2 `cat /apps/nginx/run/nginx.pid`</span><br><span class="hljs-comment">#其中USR2可以写成12，cat /apps/nginx/run/nginx.pid可以直接写成进程编号</span><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#kill -l</span><br> 1) SIGHUP	 2) SIGINT	 3) SIGQUIT	 4) SIGILL	 5) SIGTRAP<br> 6) SIGABRT	 7) SIGBUS	 8) SIGFPE	 9) SIGKILL	10) SIGUSR1<br>11) SIGSEGV	12) SIGUSR2	13) SIGPIPE	14) SIGALRM	15) SIGTERM<br>16) SIGSTKFLT	17) SIGCHLD	18) SIGCONT	19) SIGSTOP	20) SIGTSTP<br>21) SIGTTIN	22) SIGTTOU	23) SIGURG	24) SIGXCPU	25) SIGXFSZ<br>26) SIGVTALRM	27) SIGPROF	28) SIGWINCH	29) SIGIO	30) SIGPWR<br>31) SIGSYS	34) SIGRTMIN	35) SIGRTMIN+1	36) SIGRTMIN+2	37) SIGRTMIN+3<br>38) SIGRTMIN+4	39) SIGRTMIN+5	40) SIGRTMIN+6	41) SIGRTMIN+7	42) SIGRTMIN+8<br>43) SIGRTMIN+9	44) SIGRTMIN+10	45) SIGRTMIN+11	46) SIGRTMIN+12	47) SIGRTMIN+13<br>48) SIGRTMIN+14	49) SIGRTMIN+15	50) SIGRTMAX-14	51) SIGRTMAX-13	52) SIGRTMAX-12<br>53) SIGRTMAX-11	54) SIGRTMAX-10	55) SIGRTMAX-9	56) SIGRTMAX-8	57) SIGRTMAX-7<br>58) SIGRTMAX-6	59) SIGRTMAX-5	60) SIGRTMAX-4	61) SIGRTMAX-3	62) SIGRTMAX-2<br>63) SIGRTMAX-1	<br>[root@Rocky ~]<span class="hljs-comment">#ps auxf | grep nginx</span><br>root   33042  0.0  0.0  42584   852 ?   Ss  16:31   0:00 nginx: master process nginx<br>nginx  33043  0.0  0.2  74692  4932 ?   S   16:31   0:00  \_ nginx: worker process<br>root   33023  0.0  0.0  42584   852 ?   Ss  16:31   0:00 \_nginx: master process nginx<br>nginx  33024  0.0  0.2  74692  4932 ?   S   16:31   0:00      \_ nginx: worker process<br><br><span class="hljs-comment">#此时处于新旧并存，旧的还在工作</span><br></code></pre></td></tr></table></figure>

<h4 id="2-4、向旧的Nginx服务进程发送WINCH信号，使旧的Nginx-worker进程平滑停止"><a href="#2-4、向旧的Nginx服务进程发送WINCH信号，使旧的Nginx-worker进程平滑停止" class="headerlink" title="2.4、向旧的Nginx服务进程发送WINCH信号，使旧的Nginx worker进程平滑停止"></a>2.4、向旧的Nginx服务进程发送WINCH信号，使旧的Nginx worker进程平滑停止</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#先关闭旧nginx的worker进程,而不关闭nginx主进程方便回滚</span><br><span class="hljs-comment">#向原Nginx主进程发送WINCH信号，它会逐步关闭旗下的工作进程（主进程不退出），这时所有请求都会由新版Nginx处理</span><br><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#kill -WINCH `cat /apps/nginx/run/nginx.pid.oldbin`</span><br>[root@Rocky ~]<span class="hljs-comment">#ps auxf | grep nginx</span><br>root   33042  0.0  0.0  42584   852 ?   Ss  16:31   0:00 nginx: master process nginx<br>nginx  33043  0.0  0.2  74692  4932 ?   S   16:31   0:00  \_ nginx: worker process is shutting down<br>root   33023  0.0  0.0  42584   852 ?   Ss  16:31   0:00 \_nginx: master process nginx<br>nginx  33024  0.0  0.2  74692  4932 ?   S   16:31   0:00      \_ nginx: worker process<br><br>[root@centos ~]<span class="hljs-comment">#curl -I 10.0.0.185</span><br>HTTP/1.1 200 OK<br>Server: nginx/1.23.2<br><span class="hljs-comment">#此时旧版的已经不工作了，新版开始工作了。此时仍是新旧共存</span><br></code></pre></td></tr></table></figure>

<h4 id="2-5、此时新旧共存，测试一段时间新版本是否正常运行"><a href="#2-5、此时新旧共存，测试一段时间新版本是否正常运行" class="headerlink" title="2.5、此时新旧共存，测试一段时间新版本是否正常运行"></a>2.5、此时新旧共存，测试一段时间新版本是否正常运行</h4><h5 id="2-5-1、正常运行"><a href="#2-5-1、正常运行" class="headerlink" title="2.5.1、正常运行"></a>2.5.1、正常运行</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky nginx-1.23.2]<span class="hljs-comment">#kill -QUIT `cat /apps/nginx/logs/nginx.pid.oldbin`</span><br><span class="hljs-comment">#QUIT也可以写成3</span><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#nginx -V</span><br>nginx version: nginx/1.23.2<br></code></pre></td></tr></table></figure>

<h5 id="2-5-2、不能正常运行"><a href="#2-5-2、不能正常运行" class="headerlink" title="2.5.2、不能正常运行"></a>2.5.2、不能正常运行</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#回滚</span><br><span class="hljs-comment">#如果升级的版本发现问题需要回滚,可以发送HUP信号,重新拉起旧版本的worker</span><br><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#kill -HUP `cat /apps/nginx/logs/nginx.pid.oldbin`</span><br><span class="hljs-comment">#此时又新生成1个work进程</span><br>[root@centos ~]<span class="hljs-comment">#curl -I 10.0.0.185</span><br>HTTP/1.1 200 OK<br>Server: nginx/1.22.1<br><span class="hljs-comment">#最后关闭新版的master </span><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#kill -QUIT `cat /apps/nginx/logs/nginx.pid`</span><br>[root@Rocky nginx-1.23.2]<span class="hljs-comment">#cp -f /opt/nginx  /apps/nginx/sbin/  #把旧版本在替换回来 </span><br></code></pre></td></tr></table></figure>

<h3 id="三、多虚拟主机"><a href="#三、多虚拟主机" class="headerlink" title="三、多虚拟主机"></a>三、多虚拟主机</h3><p>基于不同的IP、不同的端口以及不用得域名实现不同的虚拟主机，依赖于核心模块</p>
<p>ngx_http_core_module实现。</p>
<h4 id="3-1、新建一个PC-web站点"><a href="#3-1、新建一个PC-web站点" class="headerlink" title="3.1、新建一个PC web站点"></a>3.1、新建一个PC web站点</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky ~]<span class="hljs-comment">#mkdir -p /data/nginx/html/pc  #创建页面存放路径</span><br>[root@Rocky ~]<span class="hljs-comment">#vim /data/nginx/html/pc/index.html</span><br>&lt;h1&gt; www.magedu.org &lt;/h1&gt;<br>:wq<br><br><span class="hljs-comment">#下一步设置配置文件，文件目录/apps/nginx/conf/nginx.conf。但是为了后期便于管理，可以自己再创建子目录/apps/nginx/conf.d/，在这个目录下单独创建pc站点</span><br>[root@Rocky ~]<span class="hljs-comment">#mkdir /apps/nginx/conf.d</span><br>[root@Rocky ~]<span class="hljs-comment">#vim /apps/nginx/conf/nginx.conf</span><br>include /apps/nginx/conf.d/*.conf;   <span class="hljs-comment">#将此行添加在倒数第二行，即是放在http里面，注意不要放在最前面,会导致前面的命令无法生效</span><br>[root@Rocky ~]<span class="hljs-comment">#cd /apps/nginx/conf.d</span><br>[root@Rocky conf.d]<span class="hljs-comment">#vim pc.conf</span><br>server &#123;<br>   listen 80;<br>   server_name www.magedu.org;<br>   location / &#123;<br>   root /data/nginx/html/pc;<br>   &#125;<br>&#125;<br>:wq<br><br><span class="hljs-comment">#注意，也可以写成这种形式</span><br>server &#123;<br>   listen 80;<br>   server_name www.magedu.org;<br>   root /data/nginx/html/pc;<br>&#125;<br><br>[root@Rocky conf.d]<span class="hljs-comment">#nginx -s reload</span><br><br><span class="hljs-comment">#需要搭建DNS，以前有搭建的DNS服务器（10.0.0.128）</span><br>[root@DNS ~]<span class="hljs-comment">#vim /var/named/magedu.org.zone</span><br><span class="hljs-variable">$TTL</span> 1D<br>@         IN    SOA   master  admin.magedu.org ( 6  1D  10M  1D  6H  )<br>                NS    master<br>                NS    slave1<br>master          A     10.0.0.128<br>slave1          A     10.0.0.184<br>www             A     10.0.0.184<br>:wq<br>[root@DNS ~]<span class="hljs-comment">#rndc reload                    #重新加载</span><br>server reload successful<br><br><span class="hljs-comment">#用客户端访问，需先将DNS指向10.0.0.128</span><br>[root@client ~]<span class="hljs-comment">#vim  /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>DNS1=10.0.0.128<br>:wq<br>[root@client ~]<span class="hljs-comment">#nmcli connection reload</span><br>[root@client ~]<span class="hljs-comment">#nmcli connection up eth0</span><br>[root@client ~]<span class="hljs-comment">#curl www.magedu.org</span><br>&lt;h1&gt; www.magedu.org &lt;/h1&gt;<br></code></pre></td></tr></table></figure>

<h4 id="3-2、新建一个Mobile-web站点"><a href="#3-2、新建一个Mobile-web站点" class="headerlink" title="3.2、新建一个Mobile web站点"></a>3.2、新建一个Mobile web站点</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky ~]<span class="hljs-comment">#mkdir -p /data/nginx/html/mobile  #创建页面存放路径</span><br>[root@Rocky ~]<span class="hljs-comment">#vim /data/nginx/html/mobile/index.html</span><br>&lt;h1&gt; m.magedu.org &lt;/h1&gt;<br>:wq<br>[root@Rocky ~]<span class="hljs-comment">#mkdir /apps/nginx/conf.d</span><br>[root@Rocky ~]<span class="hljs-comment">#vim /apps/nginx/conf/nginx.conf</span><br>include /apps/nginx/conf.d/*.conf;   <span class="hljs-comment">#将此行添加在倒数第二行，即是放在http里面，注意不要放在最前面,会导致前面的命令无法生效</span><br>[root@Rocky ~]<span class="hljs-comment">#cd /apps/nginx/conf.d</span><br>[root@Rocky conf.d]<span class="hljs-comment">#vim mobile.conf</span><br>server &#123;<br>   listen 80;<br>   server_name m.magedu.org;<br>   location / &#123;<br>   root /data/nginx/html/pc;<br>   &#125;<br>&#125;<br>:wq<br>[root@Rocky conf.d]<span class="hljs-comment">#nginx -s reload</span><br><br><span class="hljs-comment">#需要搭建DNS，以前有搭建的DNS服务器（10.0.0.128）</span><br>[root@DNS ~]<span class="hljs-comment">#vim /var/named/magedu.org.zone</span><br><span class="hljs-variable">$TTL</span> 1D<br>@         IN    SOA   master  admin.magedu.org ( 6  1D  10M  1D  6H  )<br>                NS    master<br>                NS    slave1<br>master          A     10.0.0.128<br>slave1          A     10.0.0.184<br>m               A     10.0.0.184<br>:wq<br>[root@DNS ~]<span class="hljs-comment">#rndc reload                    #重新加载</span><br>server reload successful<br><br><span class="hljs-comment">#用客户端访问，需先将DNS指向10.0.0.128</span><br>[root@client ~]<span class="hljs-comment">#vim  /etc/sysconfig/network-scripts/ifcfg-eth0</span><br>DNS1=10.0.0.128<br>:wq<br>[root@client ~]<span class="hljs-comment">#nmcli connection reload</span><br>[root@client ~]<span class="hljs-comment">#nmcli connection up eth0</span><br>[root@client ~]<span class="hljs-comment">#curl m.magedu.org</span><br>&lt;h1&gt; m.magedu.org &lt;/h1&gt;<br></code></pre></td></tr></table></figure>

<h4 id="3-3、还可以在pc站点下再新建一个子目录"><a href="#3-3、还可以在pc站点下再新建一个子目录" class="headerlink" title="3.3、还可以在pc站点下再新建一个子目录"></a>3.3、还可以在pc站点下再新建一个子目录</h4><h5 id="3-3-1、在-data-nginx-html-pc新建about"><a href="#3-3-1、在-data-nginx-html-pc新建about" class="headerlink" title="3.3.1、在/data/nginx/html/pc新建about"></a>3.3.1、在/data/nginx/html/pc新建about</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky ~]<span class="hljs-comment">#cd /data/nginx/html/pc</span><br>[root@Rocky pc]<span class="hljs-comment">#mkdir about</span><br>[root@Rocky pc]<span class="hljs-comment">#vim about/index.html</span><br>&lt;h1&gt; about www.magedu.org &lt;/h1&gt;<br>:wq<br></code></pre></td></tr></table></figure>

<p><a href=""><img src="image-20221128112020141.png" srcset="/img/loading.gif" lazyload alt="image-20221128112020141"></a></p>
<h5 id="3-3-2、在新的目录下创建about"><a href="#3-3-2、在新的目录下创建about" class="headerlink" title="3.3.2、在新的目录下创建about"></a>3.3.2、在新的目录下创建about</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky ~]<span class="hljs-comment">#mkdir -p /opt/pc/about</span><br>[root@Rocky ~]<span class="hljs-comment">#cd /opt/pc/about</span><br>[root@Rocky about]<span class="hljs-comment">#vim index.html</span><br>&lt;h1&gt; /opt/pc/about/index.html &lt;/h1&gt;<br>:wq<br>[root@Rocky ~]<span class="hljs-comment">#vim /apps/nginx/conf.d/pc.conf</span><br>server &#123;<br>   listen 80;<br>   server_name www.magedu.org;<br>   root /data/nginx/html/pc;<br>   location /about &#123;<br>        <span class="hljs-built_in">alias</span> /opt/pc/about;<br>   &#125;<br>&#125;<br>:wq<br></code></pre></td></tr></table></figure>

<p><a href=""><img src="image-20221128113152131.png" srcset="/img/loading.gif" lazyload alt="image-20221128113152131"></a></p>
<h3 id="四、区分不同网站的访问日志，及设置日志的类型"><a href="#四、区分不同网站的访问日志，及设置日志的类型" class="headerlink" title="四、区分不同网站的访问日志，及设置日志的类型"></a>四、区分不同网站的访问日志，及设置日志的类型</h3><h4 id="4-1、自定义日志类型"><a href="#4-1、自定义日志类型" class="headerlink" title="4.1、自定义日志类型"></a>4.1、自定义日志类型</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky ~]<span class="hljs-comment">#cd /apps/nginx/logs</span><br>[root@Rocky logs]<span class="hljs-comment">#ls</span><br>access.log  error.log  nginx.pid<br><span class="hljs-comment">#此时所有网站的访问日志都在access.log里面</span><br><br><span class="hljs-comment">#访问日志的类型设置位于http里面</span><br><span class="hljs-comment">#log_format是日志类型，放于http里面；access_log是日志的路径，放于http（适用于所有网站）或者server（适用于这一个网站）里面</span><br><span class="hljs-comment">#日志格式名称随意设置</span><br>[root@Rocky logs]<span class="hljs-comment">#vim /apps/nginx/conf/nginx.conf</span><br>http &#123;<br>    .....<br>    log_format testlog <span class="hljs-string">&#x27;$remote_addr [$time_local] &quot;$request&quot; &quot;$http_referer&quot; $status &#x27;</span>;<br>    <span class="hljs-comment">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br>    <span class="hljs-comment">#         日志格式名称   用户地址       用户名         时间           请求</span><br>    <span class="hljs-comment">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>                       <span class="hljs-comment"># 状态码   响应报文的大小      </span><br>    <span class="hljs-comment">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br>    <span class="hljs-comment">#                      浏览器的版本             </span><br>    <span class="hljs-comment">#access_log  logs/access.log  main;</span><br>    .....<br>&#125;<br>:wq<br><br>[root@Rocky logs]<span class="hljs-comment">#vim /apps/nginx/conf.d/pc.conf</span><br>server &#123;<br>   listen 80;<br>   server_name www.magedu.org;<br>   root /data/nginx/html/pc;<br>   access_log /apps/nginx/logs/access-www.magedu.org.log  testlog;  <span class="hljs-comment">#添加此行</span><br>   location /about &#123;<br>        <span class="hljs-built_in">alias</span> /opt/pc/about;<br>   &#125;<br>&#125;<br>:wq<br>[root@Rocky logs]<span class="hljs-comment">#nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>[root@Rocky logs]<span class="hljs-comment">#nginx -s reload</span><br>[root@Rocky logs]<span class="hljs-comment">#ls</span><br>access.log  access-www.magedu.org.log  error.log  nginx.pid<br></code></pre></td></tr></table></figure>

<h4 id="4-2、把日志格式设置成json格式"><a href="#4-2、把日志格式设置成json格式" class="headerlink" title="4.2、把日志格式设置成json格式"></a>4.2、把日志格式设置成json格式</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky logs]<span class="hljs-comment">#vim /apps/nginx/conf/nginx.conf</span><br>    log_format access_json <span class="hljs-string">&#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;responsetime&quot;:$request_time,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;http_host&quot;:&quot;$host&quot;,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;uri&quot;:&quot;$uri&quot;,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;tcp_xff&quot;:&quot;$proxy_protocol_addr&quot;,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#x27;</span><br>                           <span class="hljs-string">&#x27;&quot;status&quot;:&quot;$status&quot;&#125;&#x27;</span>;<br>:wq<br>[root@Rocky logs]<span class="hljs-comment">#vim /apps/nginx/conf.d/pc.conf</span><br>server &#123;<br>   listen 80;<br>   server_name www.magedu.org;<br>   root /data/nginx/html/pc;<br>   access_log /apps/nginx/logs/access-json-www.magedu.org.log access_json;  <span class="hljs-comment">#添加此行</span><br>   location /about &#123;<br>        <span class="hljs-built_in">alias</span> /opt/pc/about;<br>   &#125;<br>&#125;<br>:wq<br>[root@Rocky logs]<span class="hljs-comment">#nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>[root@Rocky logs]<span class="hljs-comment">#nginx -s reload</span><br>[root@Rocky logs]<span class="hljs-comment">#ls</span><br>access-json-www.magedu.org.log  access.log  access-www.magedu.org.log  error.log  nginx.pid<br><br><span class="hljs-comment">#现在可以观察</span><br>[root@client ~]<span class="hljs-comment">#curl www.magedu.org</span><br>&lt;h1&gt; www.magedu.org &lt;/h1&gt;<br>[root@Rocky logs]<span class="hljs-comment">#tail -f /apps/nginx/logs/access-json-www.magedu.org.log </span><br>&#123;<span class="hljs-string">&quot;@timestamp&quot;</span>:<span class="hljs-string">&quot;2022-11-28T13:28:46+08:00&quot;</span>,<span class="hljs-string">&quot;host&quot;</span>:<span class="hljs-string">&quot;10.0.0.184&quot;</span>,<span class="hljs-string">&quot;clientip&quot;</span>:<span class="hljs-string">&quot;10.0.0.185&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:26,<span class="hljs-string">&quot;responsetime&quot;</span>:0.000,<span class="hljs-string">&quot;upstreamtime&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;upstreamhost&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;http_host&quot;</span>:<span class="hljs-string">&quot;www.magedu.org&quot;</span>,<span class="hljs-string">&quot;uri&quot;</span>:<span class="hljs-string">&quot;/index.html&quot;</span>,<span class="hljs-string">&quot;xff&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;referer&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;tcp_xff&quot;</span>:<span class="hljs-string">&quot;-&quot;</span>,<span class="hljs-string">&quot;http_user_agent&quot;</span>:<span class="hljs-string">&quot;curl/7.61.1&quot;</span>,<span class="hljs-string">&quot;status&quot;</span>:<span class="hljs-string">&quot;200&quot;</span>&#125;<br><br><span class="hljs-comment">#此种形式不方便看，可以使用工具jq</span><br>[root@Rocky logs]<span class="hljs-comment">#yum -y install jq</span><br>[root@Rocky logs]<span class="hljs-comment">#cat  /apps/nginx/logs/access-json-www.magedu.org.log |jq</span><br>&#123;<br>  <span class="hljs-string">&quot;@timestamp&quot;</span>: <span class="hljs-string">&quot;2022-11-28T13:28:46+08:00&quot;</span>,<br>  <span class="hljs-string">&quot;host&quot;</span>: <span class="hljs-string">&quot;10.0.0.184&quot;</span>,<br>  <span class="hljs-string">&quot;clientip&quot;</span>: <span class="hljs-string">&quot;10.0.0.185&quot;</span>,<br>  <span class="hljs-string">&quot;size&quot;</span>: 26,<br>  <span class="hljs-string">&quot;responsetime&quot;</span>: 0.000,<br>  <span class="hljs-string">&quot;upstreamtime&quot;</span>: <span class="hljs-string">&quot;-&quot;</span>,<br>  <span class="hljs-string">&quot;upstreamhost&quot;</span>: <span class="hljs-string">&quot;-&quot;</span>,<br>  <span class="hljs-string">&quot;http_host&quot;</span>: <span class="hljs-string">&quot;www.magedu.org&quot;</span>,<br>  <span class="hljs-string">&quot;uri&quot;</span>: <span class="hljs-string">&quot;/index.html&quot;</span>,<br>  <span class="hljs-string">&quot;xff&quot;</span>: <span class="hljs-string">&quot;-&quot;</span>,<br>  <span class="hljs-string">&quot;referer&quot;</span>: <span class="hljs-string">&quot;-&quot;</span>,<br>  <span class="hljs-string">&quot;tcp_xff&quot;</span>: <span class="hljs-string">&quot;-&quot;</span>,<br>  <span class="hljs-string">&quot;http_user_agent&quot;</span>: <span class="hljs-string">&quot;curl/7.61.1&quot;</span>,<br>  <span class="hljs-string">&quot;status&quot;</span>: <span class="hljs-string">&quot;200&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="五、开启流量监控"><a href="#五、开启流量监控" class="headerlink" title="五、开启流量监控"></a>五、开启流量监控</h3><h4 id="5-1、开启Nginx的状态页"><a href="#5-1、开启Nginx的状态页" class="headerlink" title="5.1、开启Nginx的状态页"></a>5.1、开启Nginx的状态页</h4><p>基于nginx 模块 ngx_http_stub_status_module 实现，在编译安装nginx的时候需要添加编译参数 –with-http_stub_status_module，否则配置完成之后监测会是提示语法错误</p>
<p><strong>注意</strong>: 状态页显示的是整个服务器的状态,而非虚拟主机的状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#先确认是否安装 ngx_http_stub_status_module模块，如果没有需要添加</span><br>[root@Rocky ~]<span class="hljs-comment">#nginx -V</span><br>nginx version: nginx/1.20.2<br>built by gcc 8.5.0 20210514 (Red Hat 8.5.0-10) (GCC) <br>built with OpenSSL 1.1.1k  FIPS 25 Mar 2021<br>TLS SNI support enabled<br>configure arguments: --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module<br><span class="hljs-comment">#已有此模块</span><br>[root@Rocky ~]<span class="hljs-comment">#vim /apps/nginx/conf.d/pc.conf</span><br>   location /nginx_status &#123;<br>        stub_status;<br>   &#125;<br>:wq<br>[root@Rocky ~]<span class="hljs-comment">#nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>[root@Rocky ~]<span class="hljs-comment">#nginx -s reload</span><br>[root@client ~]<span class="hljs-comment">#curl http://www.magedu.org/nginx_status</span><br>Active connections: 1 <br>server accepts handled requests<br> 33 33 29 <br>Reading: 0 Writing: 1 Waiting: 0<br><br><span class="hljs-comment">#Active connections： #当前处于活动状态的客户端连接数，包括连接等待空闲连接数=reading+writing+waiting</span><br>accepts：<span class="hljs-comment">#统计总值，Nginx自启动后已经接受的客户端请求连接的总数。</span><br>handled：<span class="hljs-comment">#统计总值，Nginx自启动后已经处理完成的客户端请求连接总数，通常等于accepts，除非有因</span><br>worker_connections限制等被拒绝的连接<br>requests：<span class="hljs-comment">#统计总值，Nginx自启动后客户端发来的总的请求数。</span><br>Reading：<span class="hljs-comment">#当前状态，正在读取客户端请求报文首部的连接的连接数,数值越大,说明排队现象严重,性能不足</span><br>Writing：<span class="hljs-comment">#当前状态，正在向客户端发送响应报文过程中的连接数,数值越大,说明访问量很大</span><br>Waiting：<span class="hljs-comment">#当前状态，正在等待客户端发出请求的空闲连接数，开启 keep-alive的情况下,这个值等于</span><br>active – (reading+writing)<br><br>[root@client ~]<span class="hljs-comment">#curl http://www.magedu.org/nginx_status 2&gt;/dev/null |awk &#x27;/Reading/&#123;print $2,$4,$6&#125;&#x27;</span><br>0 1 0<br></code></pre></td></tr></table></figure>

<p><a href=""><img src="image-20221128151842453.png" srcset="/img/loading.gif" lazyload alt="image-20221128151842453"></a></p>
<h4 id="5-2、开启Nginx账户认证功能"><a href="#5-2、开启Nginx账户认证功能" class="headerlink" title="5.2、开启Nginx账户认证功能"></a>5.2、开启Nginx账户认证功能</h4><p>由 ngx_http_auth_basic_module 模块提供此功能，此模块为默认模块</p>
<p>另外设置账号密码，借助于apache的工具</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#CentOS安装包：yum -y install httpd-tools</span><br><span class="hljs-comment">#Ubuntu安装包：apt -y install apache2-utils</span><br><br>[root@Rocky ~]<span class="hljs-comment">#yum -y install httpd-tools</span><br>[root@Rocky ~]<span class="hljs-comment">#rpm -ql httpd-tools</span><br>/usr/bin/ab<br>/usr/bin/htdbm<br>/usr/bin/htdigest<br>/usr/bin/htpasswd                       <span class="hljs-comment">#借助此命令创建账号密码</span><br>/usr/bin/httxt2dbm<br>/usr/bin/logresolve<br>/usr/lib/.build-id<br>/usr/lib/.build-id/83<br>/usr/lib/.build-id/83/e9641f1054bcf7ce84912e496b7d7004e541d8<br>/usr/lib/.build-id/94/c8074f3944d2d827c17b555b26ddd231ce6d40<br>/usr/lib/.build-id/b8/8f3b9720fa23977b4d7a8de7fb789e300c2bb3<br>/usr/lib/.build-id/cb<br>/usr/lib/.build-id/cb/71e4ce4ee4e05e390dc66bdd9b290b78dd595b<br>/usr/lib/.build-id/ec<br>/usr/lib/.build-id/ec/f49ee37342186615ecf97b8224c3f74a0b2252<br>/usr/lib/.build-id/fb<br>/usr/lib/.build-id/fb/cadf8908e128a1bfc4253b351fc06595960b37<br>/usr/share/doc/httpd-tools<br>/usr/share/doc/httpd-tools/LICENSE<br>/usr/share/doc/httpd-tools/NOTICE<br>/usr/share/man/man1/ab.1.gz<br>/usr/share/man/man1/htdbm.1.gz<br>/usr/share/man/man1/htdigest.1.gz<br>/usr/share/man/man1/htpasswd.1.gz<br>/usr/share/man/man1/httxt2dbm.1.gz<br>/usr/share/man/man1/logresolve.1.gz<br>[root@Rocky ~]<span class="hljs-comment">#htpasswd -help         #查看用法</span><br>htpasswd: illegal option -- h<br>Usage:<br>	htpasswd [-cimB25dpsDv] [-C cost] [-r rounds] passwordfile username<br>	htpasswd -b[cmB25dpsDv] [-C cost] [-r rounds] passwordfile username password<br><br>	htpasswd -n[imB25dps] [-C cost] [-r rounds] username<br>	htpasswd -nb[mB25dps] [-C cost] [-r rounds] username password<br> -c  Create a new file.<br> -n  Don<span class="hljs-string">&#x27;t update file; display results on stdout.</span><br><span class="hljs-string"> -b  Use the password from the command line rather than prompting for it.</span><br><span class="hljs-string">[root@Rocky ~]#htpasswd -bc /apps/nginx/conf.d/.nginx-user  zhang  123456</span><br><span class="hljs-string">Adding password for user zhang</span><br><span class="hljs-string">#                                存放路径                     账号    密码</span><br><span class="hljs-string">[root@Rocky ~]#cat /apps/nginx/conf.d/.nginx-user </span><br><span class="hljs-string">zhang:$apr1$xstp1TOk$IRjBaDIckZXRt3hVdQgBW0</span><br><span class="hljs-string">#创建第二个账号时，命令为htpasswd -b /apps/nginx/conf.d/.nginx-user  账号  密码。如果+c是替换旧账号，不+c是增加新账号</span><br><span class="hljs-string"></span><br><span class="hljs-string">#进行安全加固</span><br><span class="hljs-string">[root@Rocky ~]#chown nginx.nginx /apps/nginx/conf.d/.nginx-user</span><br><span class="hljs-string">[root@Rocky ~]#chmod 600 /apps/nginx/conf.d/.nginx-user</span><br><span class="hljs-string">[root@Rocky ~]#vim /apps/nginx/conf.d/pc.conf</span><br><span class="hljs-string">location /nginx_status &#123;</span><br><span class="hljs-string">        stub_status;</span><br><span class="hljs-string">        auth_basic  &quot;waring&quot;;                   #waring只是提示词，可以随意写</span><br><span class="hljs-string">        auth_basic_user_file  /apps/nginx/conf.d/.nginx-user;</span><br><span class="hljs-string">   &#125;</span><br><span class="hljs-string">:wq</span><br><span class="hljs-string">#注意auth_basic和auth_basic_user_file可以放在http（所有网站）、server（其中一个网站）、location（网站中的1个页面）</span><br><span class="hljs-string">[root@Rocky ~]#nginx -t</span><br><span class="hljs-string">nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok</span><br><span class="hljs-string">nginx: configuration file /apps/nginx/conf/nginx.conf test is successful</span><br><span class="hljs-string">[root@Rocky ~]#nginx -s reload</span><br></code></pre></td></tr></table></figure>

<p><a href=""><img src="image-20221128155842696.png" srcset="/img/loading.gif" lazyload alt="image-20221128155842696"></a></p>
<h4 id="5-3、Nginx-四层访问控制"><a href="#5-3、Nginx-四层访问控制" class="headerlink" title="5.3、Nginx 四层访问控制"></a>5.3、Nginx 四层访问控制</h4><p>访问控制基于模块ngx_http_access_module（默认模块）实现，可以通过匹配客户端源IP地址进行限制</p>
<p><strong>注意</strong>: 如果能在防火墙设备控制,最好就不要在nginx上配置,可以更好的节约资源</p>
<p>官方帮助: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ABAP">http://nginx.org/en/docs/http/ngx_http_access_module.html<br></code></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky ~]<span class="hljs-comment">#vim /apps/nginx/conf.d/pc.conf</span><br>  location /nginx_status &#123;<br>        stub_status;<br>        auth_basic  <span class="hljs-string">&quot;waring&quot;</span>;<br>        auth_basic_user_file  /apps/nginx/conf.d/.nginx-user;<br>        deny 10.0.0.185;              <span class="hljs-comment">#拒绝10.0.0.185访问</span><br>        allow 10.0.0.0/24;            <span class="hljs-comment">#允许10.0.0.0/24访问，另外允许与拒绝按上下顺序执行</span><br>   &#125;<br>:wq<br><span class="hljs-comment">#注意allow和deny可以放在http（所有网站）、server（其中一个网站）、location（网站中的1个页面）</span><br>[root@Rocky ~]<span class="hljs-comment">#nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>[root@Rocky ~]<span class="hljs-comment">#nginx -s reload</span><br><br><span class="hljs-comment">#10.0.0.185机器访问</span><br>[root@client ~]<span class="hljs-comment">#curl http://zhang:123456@www.magedu.org/nginx_status</span><br>&lt;html&gt;<br>&lt;<span class="hljs-built_in">head</span>&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;<br>&lt;hr&gt;&lt;center&gt;nginx/1.20.2&lt;/center&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><span class="hljs-comment">#10.0.0.186机器访问</span><br>[root@Rocky ~]<span class="hljs-comment">#curl http://zhang:123456@www.magedu.org/nginx_status</span><br>Active connections: 1 <br>server accepts handled requests<br> 46 46 50 <br>Reading: 0 Writing: 1 Waiting: 0 <br></code></pre></td></tr></table></figure>

<h3 id="六、安装第三方echo模块实现信息显示"><a href="#六、安装第三方echo模块实现信息显示" class="headerlink" title="六、安装第三方echo模块实现信息显示"></a>六、安装第三方echo模块实现信息显示</h3><p>开源的echo模块可以用来打印信息,变量等</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ABAP">https://github.com/openresty/echo-nginx-module<br></code></pre></td></tr></table></figure>

<p><a href=""><img src="image-20221128163638945.png" srcset="/img/loading.gif" lazyload alt="image-20221128163638945"></a></p>
<h4 id="6-1、安装echo模块"><a href="#6-1、安装echo模块" class="headerlink" title="6.1、安装echo模块"></a>6.1、安装echo模块</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky ~]<span class="hljs-comment">#cd /usr/local/src</span><br>[root@Rocky src]<span class="hljs-comment">#wget https://github.com/openresty/echo-nginx-module/archive/refs/tags/v0.63.tar.gz</span><br>[root@Rocky src]<span class="hljs-comment">#ls</span><br>nginx-1.20.2  nginx-1.20.2.tar.gz  nginx-module-vts-0.2.1  v0.2.1.tar.gz  v0.63.tar.gz<br>[root@Rocky src]<span class="hljs-comment">#tar xf v0.63.tar.gz </span><br>[root@Rocky src]<span class="hljs-comment">#ls</span><br>echo-nginx-module-0.63  nginx-1.20.2  nginx-1.20.2.tar.gz  nginx-module-vts-0.2.1  v0.2.1.tar.gz  v0.63.tar.gz<br>[root@Rocky nginx-1.20.2]<span class="hljs-comment">#cd nginx-1.20.2/</span><br>[root@Rocky nginx-1.20.2]<span class="hljs-comment">#./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/usr/local/src/echo-nginx-module-0.63</span><br>[root@Rocky nginx-1.20.2]<span class="hljs-comment">#make -j 2 &amp;&amp; make install</span><br>[root@Rocky nginx-1.20.2]<span class="hljs-comment">#systemctl restart nginx</span><br></code></pre></td></tr></table></figure>

<h4 id="6-2、设置配置文件"><a href="#6-2、设置配置文件" class="headerlink" title="6.2、设置配置文件"></a>6.2、设置配置文件</h4><p>Nginx里的变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ABAP">http://nginx.org/en/docs/varindex.html<br></code></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky ~]<span class="hljs-comment">#vim /apps/nginx/conf.d/pc.conf</span><br>   location /echo &#123;<br>       <span class="hljs-built_in">set</span> <span class="hljs-variable">$class</span> n68;       <span class="hljs-comment">#可以自定义变量，使用在server和location</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-variable">$class</span>;          <span class="hljs-comment">#打印自定义变量</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;hello&quot;</span>;         <span class="hljs-comment">#可以打印字符串</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-variable">$remote_addr</span>;    <span class="hljs-comment">#可以打印变量，用户地址</span><br>       <span class="hljs-built_in">echo</span> <span class="hljs-variable">$uri</span>;            <span class="hljs-comment">#可以打印变量，访问的地址是什么</span><br>   &#125;<br>:wq<br>[root@Rocky ~]<span class="hljs-comment">#nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>[root@Rocky ~]<span class="hljs-comment">#nginx -s reload</span><br><br>[root@client ~]<span class="hljs-comment">#curl http://www.magedu.org/echo</span><br>n68<br>hello<br>10.0.0.185<br>/echo<br></code></pre></td></tr></table></figure>

<h3 id="七、nginx的反向代理"><a href="#七、nginx的反向代理" class="headerlink" title="七、nginx的反向代理"></a>七、nginx的反向代理</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sh">环境配置：<br>10.0.0.184  为反向代理服务器<br>10.0.0.185  为后端服务器<br><br><span class="hljs-comment">#配置反向代理服务器</span><br>[root@server conf.d]<span class="hljs-comment">#vim pc.conf</span><br>server &#123;<br>   listen 80;<br>   server_name www.magedu.org;<br>   root /data/nginx/html/pc;<br>   access_log /apps/nginx/logs/access-json-www.magedu.org.log access_json;<br>   location / &#123;<br>        proxy_pass http://10.0.0.185;        <span class="hljs-comment">#添加此项即可开启反向代理服务</span><br>   &#125;<br>&#125;<br>:wq<br>[root@server conf.d]<span class="hljs-comment">#nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>[root@server conf.d]<span class="hljs-comment">#nginx -s reload</span><br><br><span class="hljs-comment">#nginx的方向代理时，后端服务器只能看到访问地址是方向代理服务器，看不到客户端地址（反向代理服务器可以看到客户端地址）</span><br>[root@Rocky nginx]<span class="hljs-comment">#tail -f logs/access.log     #后端服务器</span><br>10.0.0.184 - - [29/Nov/2022:13:20:49 +0800] <span class="hljs-string">&quot;GET / HTTP/1.0&quot;</span> 200 607 <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-string">&quot;curl/7.61.1&quot;</span><br></code></pre></td></tr></table></figure>

<p><a href=""><img src="image-20221129131337835.png" srcset="/img/loading.gif" lazyload alt="image-20221129131337835"></a></p>
<h3 id="八、nginx的负载均衡"><a href="#八、nginx的负载均衡" class="headerlink" title="八、nginx的负载均衡"></a>八、nginx的负载均衡</h3><p>Nginx 可以基于ngx_http_upstream_module模块提供服务器分组转发、权重分配、状态监测、调度算法等高级功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ABAP">https://nginx.org/en/docs/http/ngx_http_upstream_module.html<br></code></pre></td></tr></table></figure>

<h4 id="8-1、http-upstream配置参数"><a href="#8-1、http-upstream配置参数" class="headerlink" title="8.1、http upstream配置参数"></a>8.1、http upstream配置参数</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#自定义一组服务器，配置在http块内</span><br>upstream name &#123; <br> server .....<br> ......<br>&#125;<br><br><span class="hljs-comment">#示例</span><br>upstream backend &#123;<br>   server backend1.example.com weight=5;<br>   server 127.0.0.1:8080  max_fails=3 fail_timeout=30s;<br>   server unix:/tmp/backend3;<br>   server backup1.example.com backup;<br>&#125;<br><br>server address [parameters];<br><span class="hljs-comment">#配置一个后端web服务器，配置在upstream内，至少要有一个server服务器配置。</span><br><span class="hljs-comment">#server支持的parameters如下：</span><br>weight=number <span class="hljs-comment">#设置权重，默认为1,实现类似于LVS中的WRR,WLC等</span><br>max_conns=number  <span class="hljs-comment">#给当前后端server设置最大活动链接数，默认为0表示没有限制</span><br>max_fails=number  <span class="hljs-comment">#后端服务器的下线条件,当客户端访问时,对本次调度选中的后端服务器连续进行检测</span><br>多少次,如果都失败就标记为不可用,默认为1次,当客户端访问时,才会利用TCP触发对探测后端服务器健康性<br>检查,而非周期性的探测<br>fail_timeout=time <span class="hljs-comment">#后端服务器的上线条件,对已经检测到处于不可用的后端服务器,每隔此时间间隔再次</span><br>进行检测是否恢复可用，如果发现可用,则将后端服务器参与调度,默认为10秒<br>backup  <span class="hljs-comment">#设置为备份服务器，当所有后端服务器不可用时,才会启用此备用服务器</span><br>down    <span class="hljs-comment">#标记为down状态,可以平滑下线后端服务器,新用户不再调度到此主机,旧用户不受影响</span><br></code></pre></td></tr></table></figure>

<h4 id="8-2、负载均衡参数设置"><a href="#8-2、负载均衡参数设置" class="headerlink" title="8.2、负载均衡参数设置"></a>8.2、负载均衡参数设置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@proxy ~]<span class="hljs-comment">#cd /apps/nginx/conf.d</span><br>[root@proxy conf.d]<span class="hljs-comment">#vim pc.conf</span><br>upstream webserver &#123;                 <span class="hljs-comment">#添加upstream,后端服务器有下面两台</span><br>      server 10.0.0.185;<br>      server 10.0.0.186;<br>&#125;<br>server &#123;<br>   listen 80;<br>   server_name www.magedu.org;<br>   access_log /apps/nginx/logs/access-json-www.magedu.org.log access_json;<br>   root /data/nginx/html/pc;<br>   location / &#123;<br>       proxy_pass http://webserver;    <span class="hljs-comment">#反向代理功能，代理的地址webserver与负载均衡功能upstream设置的名字一致</span><br>   &#125;<br>&#125;<br>:wq<br>[root@proxy conf.d]<span class="hljs-comment">#nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>[root@proxy conf.d]<span class="hljs-comment">#nginx -s reload</span><br><span class="hljs-comment">#注意此时负载均衡采用的轮询算法（即默认算法）</span><br></code></pre></td></tr></table></figure>

<h3 id="九、实现nginx四层负载均衡"><a href="#九、实现nginx四层负载均衡" class="headerlink" title="九、实现nginx四层负载均衡"></a>九、实现nginx四层负载均衡</h3><p>Nginx在1.9.0版本开始支持tcp模式的负载均衡，在1.9.13版本开始支持udp协议的负载，udp主要用于DNS的域名解析，其配置方式和指令和http 代理类似，其基于ngx_stream_proxy_module模块实现tcp负载，另外基于模块ngx_stream_upstream_module实现后端服务器分组转发、权重分配、状态监测、调度算法等高级功能。</p>
<p><strong>如果编译安装,需要指定 –with-stream 选项才能支持ngx_stream_proxy_module模块</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ABAP">官方文档：<br>https://nginx.org/en/docs/stream/ngx_stream_proxy_module.html<br>http://nginx.org/en/docs/stream/ngx_stream_upstream_module.html<br></code></pre></td></tr></table></figure>

<h4 id="9-1、tcp负载均衡配置参数"><a href="#9-1、tcp负载均衡配置参数" class="headerlink" title="9.1、tcp负载均衡配置参数"></a>9.1、tcp负载均衡配置参数</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#stream语句块放在main里面，与http语句块同级</span><br>stream &#123;<br>   upstream backend &#123; <span class="hljs-comment">#定义后端服务器</span><br>       <span class="hljs-built_in">hash</span> <span class="hljs-variable">$remote_addr</span> consistent; <span class="hljs-comment">#定义调度算法</span><br>       server backend1.example.com:12345 weight=5; <span class="hljs-comment">#定义具体server</span><br>       server 127.0.0.1:12345      max_fails=3 fail_timeout=30s;<br>       server unix:/tmp/backend3;<br>   &#125;<br>   upstream dns &#123;  <span class="hljs-comment">#定义后端服务器</span><br>       server 10.0.0.1:53535;  <span class="hljs-comment">#定义具体server</span><br>       server dns.example.com:53;<br>   &#125;<br>   server &#123; <span class="hljs-comment">#定义server</span><br>       listen 12345; <span class="hljs-comment">#监听IP:PORT</span><br>       proxy_connect_timeout 1s; <span class="hljs-comment">#连接超时时间</span><br>       proxy_timeout 3s; <span class="hljs-comment">#转发超时时间</span><br>       proxy_pass backend; <span class="hljs-comment">#转发到具体服务器组</span><br>   &#125;<br>   server &#123;<br>       listen 127.0.0.1:53 udp reuseport;<br>       proxy_timeout 20s;<br>       proxy_pass dns;<br>   &#125;<br>   server &#123;<br>       listen [::1]:12345;<br>       proxy_pass unix:/tmp/stream.socket;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="9-2、实现负载均衡（redis和mysql类似）"><a href="#9-2、实现负载均衡（redis和mysql类似）" class="headerlink" title="9.2、实现负载均衡（redis和mysql类似）"></a>9.2、实现负载均衡（redis和mysql类似）</h4><p><a href=""><img src="image-20221130102253614.png" srcset="/img/loading.gif" lazyload alt="image-20221130102253614"></a></p>
<h5 id="9-2-1、后端服务器安装redis"><a href="#9-2-1、后端服务器安装redis" class="headerlink" title="9.2.1、后端服务器安装redis"></a>9.2.1、后端服务器安装redis</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#安装两台redis服务器</span><br>[root@centos8 ~]<span class="hljs-comment"># yum -y install redis </span><br>[root@centos8 ~]<span class="hljs-comment"># sed -i &#x27;/^bind /c bind 0.0.0.0&#x27; /etc/redis.conf</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl enable --now redis</span><br>[root@centos8 ~]<span class="hljs-comment"># ss -tnl | grep 6379</span><br>LISTEN     0      128         *:6379                     *:*<br></code></pre></td></tr></table></figure>

<h5 id="9-2-2、反向代理nginx配置"><a href="#9-2-2、反向代理nginx配置" class="headerlink" title="9.2.2、反向代理nginx配置"></a>9.2.2、反向代理nginx配置</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@centos8 ~]<span class="hljs-comment"># vim /apps/nginx/conf/nginx.conf</span><br>include /apps/nginx/conf/tcp/tcp.conf; <span class="hljs-comment">#注意此处的include与http模块平级</span><br>[root@centos8 ~]<span class="hljs-comment"># mkdir /apps/nginx/conf/tcp</span><br>[root@centos8 ~]<span class="hljs-comment"># cat /apps/nginx/conf/tcp/tcp.conf   #也可直接在总配置文件里编辑</span><br>stream &#123;<br> upstream redis_server &#123;<br>    <span class="hljs-comment">#hash $remote_addr consistent;</span><br>   server 10.0.0.18:6379 max_fails=3 fail_timeout=30s;<br>   server 10.0.0.28:6379 max_fails=3 fail_timeout=30s;<br> &#125;<br> server &#123;<br>   listen 10.0.0.8:6379;             <span class="hljs-comment">#可直接写listen 6379;</span><br>   proxy_connect_timeout 3s;<br>   proxy_timeout 3s;<br>   proxy_pass redis_server;<br> &#125;<br>&#125;<br><span class="hljs-comment">#重启nginx并访问测试</span><br>[root@centos8 ~]<span class="hljs-comment"># systemctl restart nginx</span><br>[root@centos8 ~]<span class="hljs-comment"># ss -tnl | grep 6379</span><br>LISTEN     0      128    10.0.0.8:6379                     *:*  <br><span class="hljs-comment">#测试通过nginx 负载连接redis：</span><br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.8 set name wang </span><br>OK<br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.8 get name</span><br>(nil)<br>[root@centos8 ~]<span class="hljs-comment">#redis-cli -h 10.0.0.8 get name</span><br><span class="hljs-string">&quot;wang&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="十、实现FastCGI（异构代理）"><a href="#十、实现FastCGI（异构代理）" class="headerlink" title="十、实现FastCGI（异构代理）"></a>十、实现FastCGI（异构代理）</h3><p><strong>前面的代理都属于同构代理</strong></p>
<p><a href=""><img src="image-20221130103145411.png" srcset="/img/loading.gif" lazyload alt="image-20221130103145411"></a></p>
<p>nginx缺通过与第三方基于协议实现，即通过某种特定协议将客户端请求转发给第三方服务处理，<strong>第三方服务器会新建新的进程处理用户的请求，处理完成后返回数据给Nginx并回收进程</strong>，最后nginx在返回给客户端，那这个约定就是通用网关接口(common gateway interface，简称CGI)，CGI（协议） 是web服务器和外部应用程序之间的接口标准，是cgi程序和web服务器之间传递信息的标准化接口。</p>
<p>Nginx基于模块ngx_http_fastcgi_module实现通过fastcgi协议将指定的客户端请求转发至php-fpm处</p>
<p>理，其配置指令如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh">fastcgi_pass address;<br><span class="hljs-comment">#转发请求到后端服务器，address为后端的fastcgi server的地址，可用位置：location, if in location</span><br><br><span class="hljs-comment">#示例</span><br>fastcgi_pass localhost:9000;<br>fastcgi_pass unix:/tmp/fastcgi.socket;<br><br>fastcgi_index name;<br><span class="hljs-comment">#fastcgi默认的主页资源，示例：fastcgi_index index.php;</span><br><br>fastcgi_param parameter value [if_not_empty];<br><span class="hljs-comment">#设置传递给FastCGI服务器的参数值，可以是文本，变量或组合，可用于将Nginx的内置变量赋值给自定义key</span><br>fastcgi_param REMOTE_ADDR        <span class="hljs-variable">$remote_addr</span>; <span class="hljs-comment">#客户端源IP</span><br>fastcgi_param REMOTE_PORT        <span class="hljs-variable">$remote_port</span>; <span class="hljs-comment">#客户端源端口</span><br>fastcgi_param SERVER_ADDR        <span class="hljs-variable">$server_addr</span>; <span class="hljs-comment">#请求的服务器IP地址</span><br>fastcgi_param SERVER_PORT        <span class="hljs-variable">$server_port</span>; <span class="hljs-comment">#请求的服务器端口</span><br>fastcgi_param SERVER_NAME        <span class="hljs-variable">$server_name</span>; <span class="hljs-comment">#请求的server name</span><br><br>Nginx默认配置示例：<br>   location ~ \.php$ &#123;<br>     root           /scripts;<br>     fastcgi_pass   127.0.0.1:9000;<br>     fastcgi_index index.php;<br>     fastcgi_param SCRIPT_FILENAME  $document_root<span class="hljs-variable">$fastcgi_script_name</span>; <span class="hljs-comment">#默认脚</span><br>本路径<br>      <span class="hljs-comment">#fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name; #此行写法不再需要上面的 root 指令</span><br>     include       fastcgi_params;    <span class="hljs-comment">#此文件默认系统已提供,存放的相对路径为prefix/conf</span><br>   &#125;<br></code></pre></td></tr></table></figure>



<h4 id="10-1、-FastCGI实战案例-Nginx与php不在同一个服务器"><a href="#10-1、-FastCGI实战案例-Nginx与php不在同一个服务器" class="headerlink" title="10.1、 FastCGI实战案例: Nginx与php不在同一个服务器"></a>10.1、 FastCGI实战案例: Nginx与php不在同一个服务器</h4><p>nginx会处理静态请求，但是会转发动态请求到后端指定的php-fpm服务器，因此php代码需要放在后端</p>
<p>的php-fpm服务器，即静态页面放在Nginx服务器上,而动态页面放在后端php-fpm服务器，通常情况</p>
<p>下，一般都是采用在同一个服务器</p>
<p><a href=""><img src="image-20221130105907996.png" srcset="/img/loading.gif" lazyload alt="image-20221130105907996"></a></p>
<h5 id="10-1-1、php-fpm的配置文件"><a href="#10-1-1、php-fpm的配置文件" class="headerlink" title="10.1.1、php-fpm的配置文件"></a>10.1.1、php-fpm的配置文件</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@php-fpm ~]<span class="hljs-comment">#yum -y install php-fpm            #安装软件</span><br>[root@php-fpm ~]<span class="hljs-comment">#rpm -ql php-fpm                   #查看软件的配置</span><br>/etc/httpd/conf.d/php.conf<br>/etc/logrotate.d/php-fpm<br>/etc/nginx/conf.d/php-fpm.conf<br>/etc/nginx/default.d/php.conf<br>/etc/php-fpm.conf                                 <span class="hljs-comment">#主配置文件</span><br>/etc/php-fpm.d<br>/etc/php-fpm.d/www.conf                           <span class="hljs-comment">#子配置文件</span><br>/etc/systemd/system/php-fpm.service.d<br>/run/php-fpm<br>/usr/lib/.build-id<br>/usr/lib/.build-id/eb<br>/usr/lib/.build-id/eb/2f5f408539a6608c445913b3214d215b421869<br>/usr/lib/systemd/system/httpd.service.d/php-fpm.conf<br>/usr/lib/systemd/system/nginx.service.d/php-fpm.conf<br>/usr/lib/systemd/system/php-fpm.service          <span class="hljs-comment">#有service文件，可以使用system功能</span><br>/usr/sbin/php-fpm<br>/usr/share/doc/php-fpm<br>/usr/share/doc/php-fpm/php-fpm.conf.default<br>/usr/share/doc/php-fpm/www.conf.default<br>/usr/share/fpm<br>/usr/share/fpm/status.html<br>/usr/share/licenses/php-fpm<br>/usr/share/licenses/php-fpm/fpm_LICENSE<br>/usr/share/man/man8/php-fpm.8.gz<br>/var/lib/php/opcache<br>/var/lib/php/session<br>/var/lib/php/wsdlcache<br>/var/log/php-fpm<br><span class="hljs-comment">#php-fpm的监听端口是9000</span><br>[root@php-fpm ~]<span class="hljs-comment">#ss -ntl</span><br>State    Recv-Q   Send-Q     Local Address:Port    Peer Address:Port    Process     <br>LISTEN    0        128        0.0.0.0:22            0.0.0.0:*                       <br>LISTEN    0        128        0.0.0.0:80            0.0.0.0:*                       <br>LISTEN    0        128        [::]:22               [::]:*    <br>[root@php-fpm ~]<span class="hljs-comment">#systemctl enable --now php-fpm      #启动服务</span><br>[root@php-fpm ~]<span class="hljs-comment">#ps auxf | grep php-fpm          #此时可以看到php-fpm以Apache账号启动了</span><br>root        1870  0.0  0.9 166940 17744 ?        Ss   11:06   0:00 php-fpm: master process (/etc/php-fpm.conf)<br>apache      1871  0.0  0.5 183288  9896 ?        S    11:06   0:00  \_ php-fpm: pool www<br>apache      1872  0.0  0.5 183288 10208 ?        S    11:06   0:00  \_ php-fpm: pool www<br>apache      1873  0.0  0.5 183288 10208 ?        S    11:06   0:00  \_ php-fpm: pool www<br>apache      1874  0.0  0.5 183288  9824 ?        S    11:06   0:00  \_ php-fpm: pool www<br>apache      1875  0.0  0.5 183288 10208 ?        S    11:06   0:00  \_ php-fpm: pool www<br><span class="hljs-comment">#为了便于统一管理，或者后期nginx和php-fpm合为一台机器上时账号统一，需更改账号</span><br>[root@php-fpm ~]<span class="hljs-comment">#vim /etc/php-fpm.d/www.conf</span><br>; RPM: apache user chosen to provide access to the same directories as httpd<br>user = nginx                       <span class="hljs-comment">#将Apache改为nginx</span><br>; RPM: Keep a group allowed to write <span class="hljs-keyword">in</span> <span class="hljs-built_in">log</span> <span class="hljs-built_in">dir</span>.<br>group = nginx                      <span class="hljs-comment">#将Apache改为nginx</span><br>[root@php-fpm ~]<span class="hljs-comment">#systemctl restart php-fpm          #重新启动，此时账号就改为nginx了</span><br><br><span class="hljs-comment">#但此时仍没有9000端口</span><br>[root@php-fpm ~]<span class="hljs-comment">#ss -ntl</span><br>State    Recv-Q   Send-Q     Local Address:Port    Peer Address:Port    Process     <br>LISTEN    0        128        0.0.0.0:22            0.0.0.0:*                       <br>LISTEN    0        128        0.0.0.0:80            0.0.0.0:*                       <br>LISTEN    0        128        [::]:22               [::]:*<br><span class="hljs-comment">#因为此软件默认以文件的方式监听（即只能在本机访问，不能跨网络访问），跨网络访问需更改配置</span><br>[root@php-fpm ~]<span class="hljs-comment">#vim /etc/php-fpm.d/www.conf</span><br>; Note: This value is mandatory.<br>;listen = /run/php-fpm/www.sock             <span class="hljs-comment">#添加；注释此行</span><br>listen = 9000                               <span class="hljs-comment">#添加此行</span><br>[root@php-fpm ~]<span class="hljs-comment">#systemctl restart php-fpm</span><br>[root@php-fpm ~]<span class="hljs-comment">#ss -ntl</span><br>State    Recv-Q   Send-Q     Local Address:Port    Peer Address:Port    Process     <br>LISTEN    0        128        0.0.0.0:22            0.0.0.0:*                       <br>LISTEN    0        128        0.0.0.0:80            0.0.0.0:*                       <br>LISTEN    0        128        [::]:22               [::]:*<br>LISTEN    0        128        *:9000                *:*<br><span class="hljs-comment">#但配置文件默认权限是本机127.0.0.1，需更改否则跨网络9000不起作用</span><br>[root@php-fpm ~]<span class="hljs-comment">#vim /etc/php-fpm.d/www.conf</span><br>;Default Value: any                        <span class="hljs-comment">#此行默认都能访问</span><br>;listen.allowed_clients = 127.0.0.1        <span class="hljs-comment">#添加；注释此行</span><br>[root@php-fpm ~]<span class="hljs-comment">#systemctl restart php-fpm</span><br><br><span class="hljs-comment">#创建存放PHP程序的存放路径</span><br>[root@php-fpm ~]<span class="hljs-comment">#mkdir /data/php -p</span><br>[root@php-fpm ~]<span class="hljs-comment">#cd /data/php</span><br>[root@php-fpm php]<span class="hljs-comment">#vim test.php</span><br>&lt;?php<br>phpinfo();<br>?&gt;<br>:wq<br></code></pre></td></tr></table></figure>

<h5 id="10-1-2、反向代理nginx的配置"><a href="#10-1-2、反向代理nginx的配置" class="headerlink" title="10.1.2、反向代理nginx的配置"></a>10.1.2、反向代理nginx的配置</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@proxy conf.d]<span class="hljs-comment">#vim pc.conf</span><br>server &#123;<br>   listen 80;<br>   server_name www.magedu.org;<br>   access_log /apps/nginx/logs/access-json-www.magedu.org.log access_json;<br>   root /data/nginx/html/pc;<br>   location / &#123;<br>       proxy_pass http://webserver;<br>   &#125;<br>   location ~ \.php$ &#123;<br>       root           /data/php;           <span class="hljs-comment">#php的存放路径</span><br>       fastcgi_pass   10.0.0.185:9000;<br>       fastcgi_index  index.php;<br>       fastcgi_param  SCRIPT_FILENAME  $document_root<span class="hljs-variable">$fastcgi_script_name</span>;  <span class="hljs-comment">#$document_root表示/data/php，$fastcgi_script_name表示/data/php下的某一文件名称</span><br>       include        fastcgi_params;      <span class="hljs-comment">#系统固定设置，不变</span><br>   &#125;<br>&#125;<br>:wq<br>[root@proxy conf.d]<span class="hljs-comment">#nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>[root@proxy conf.d]<span class="hljs-comment">#nginx -s reload</span><br></code></pre></td></tr></table></figure>

<p><a href=""><img src="image-20221130115618073.png" srcset="/img/loading.gif" lazyload alt="image-20221130115618073"></a></p>
<h5 id="10-1-3、php-fpm也可以开启状态页和ping"><a href="#10-1-3、php-fpm也可以开启状态页和ping" class="headerlink" title="10.1.3、php-fpm也可以开启状态页和ping"></a>10.1.3、php-fpm也可以开启状态页和ping</h5><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@php-fpm php]<span class="hljs-comment">#vim /etc/php-fpm.d/www.conf</span><br>; Default Value: not <span class="hljs-built_in">set</span><br>pm.status_path = /fpm_status          <span class="hljs-comment">#取消此行注释,且便于区分，将status改为fpm_status</span><br>.....<br>; Default Value: not <span class="hljs-built_in">set</span><br>ping.path = /ping                 <span class="hljs-comment">#取消此行注释</span><br>....<br>; Default Value: pong<br>ping.response = pong              <span class="hljs-comment">#取消此行注释</span><br>:wq<br>[root@php-fpm php]<span class="hljs-comment">#systemctl restart php-fpm</span><br><br>[root@proxy conf.d]<span class="hljs-comment">#vim pc.conf</span><br>server &#123;<br>   ......<br>   location ~ ^/(ping|fpm_status)$ &#123;<br>       fastcgi_pass   10.0.0.185:9000;<br>       fastcgi_param  PATH_TRANSLATED $document_root<span class="hljs-variable">$fastcgi_script_name</span>;<br>       include fastcgi_params;<br>   &#125;<br>&#125;<br>[root@proxy conf.d]<span class="hljs-comment">#nginx -s reload</span><br></code></pre></td></tr></table></figure>

<p><a href=""><img src="image-20221130122042043.png" srcset="/img/loading.gif" lazyload alt="image-20221130122042043"></a></p>
<p><a href=""><img src="image-20221130122106468.png" srcset="/img/loading.gif" lazyload alt="image-20221130122106468"></a></p>
<h3 id="十一、项目实战-利用LNMP实现WordPress站点搭建"><a href="#十一、项目实战-利用LNMP实现WordPress站点搭建" class="headerlink" title="十一、项目实战:利用LNMP实现WordPress站点搭建"></a>十一、项目实战:利用LNMP实现WordPress站点搭建</h3><p><a href=""><img src="image-20221130141246807.png" srcset="/img/loading.gif" lazyload alt="image-20221130141246807"></a></p>
<h4 id="10-1、LNP的配置"><a href="#10-1、LNP的配置" class="headerlink" title="10.1、LNP的配置"></a>10.1、LNP的配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#此前已安装nginx</span><br>[root@LNP ~]<span class="hljs-comment">#yum -y install php-fpm php-json php-mysqlnd</span><br><br><span class="hljs-comment">#先修改php-fpm配置文件</span><br>[root@LNP ~]<span class="hljs-comment">#rpm -ql php-fpm</span><br>/etc/httpd/conf.d/php.conf<br>/etc/logrotate.d/php-fpm<br>/etc/nginx/conf.d/php-fpm.conf<br>/etc/nginx/default.d/php.conf<br>/etc/php-fpm.conf<br>/etc/php-fpm.d<br>/etc/php-fpm.d/www.conf<br>/etc/systemd/system/php-fpm.service.d<br>/run/php-fpm<br>/usr/lib/.build-id<br>/usr/lib/.build-id/eb<br>/usr/lib/.build-id/eb/2f5f408539a6608c445913b3214d215b421869<br>/usr/lib/systemd/system/httpd.service.d/php-fpm.conf<br>/usr/lib/systemd/system/nginx.service.d/php-fpm.conf<br>/usr/lib/systemd/system/php-fpm.service<br>/usr/sbin/php-fpm<br>/usr/share/doc/php-fpm<br>/usr/share/doc/php-fpm/php-fpm.conf.default<br>/usr/share/doc/php-fpm/www.conf.default<br>/usr/share/fpm<br>/usr/share/fpm/status.html<br>/usr/share/licenses/php-fpm<br>/usr/share/licenses/php-fpm/fpm_LICENSE<br>/usr/share/man/man8/php-fpm.8.gz<br>/var/lib/php/opcache<br>/var/lib/php/session<br>/var/lib/php/wsdlcache<br>/var/log/php-fpm<br>[root@LNP ~]<span class="hljs-comment">#vim /etc/php-fpm.d/www.conf</span><br>; RPM: apache user chosen to provide access to the same directories as httpd<br>user = nginx                       <span class="hljs-comment">#将Apache改为nginx</span><br>; RPM: Keep a group allowed to write <span class="hljs-keyword">in</span> <span class="hljs-built_in">log</span> <span class="hljs-built_in">dir</span>.<br>group = nginx                      <span class="hljs-comment">#将Apache改为nginx</span><br>; listen = /run/php-fpm/www.sock   <span class="hljs-comment">#将此行注释</span><br>listen = 127.0.0.1:9000            <span class="hljs-comment">#添加此行</span><br>.....<br>; Default Value: not <span class="hljs-built_in">set</span><br>pm.status_path = /fpm_status       <span class="hljs-comment">#取消此行注释,且便于区分，将status改为fpm_status</span><br>.....<br>; Default Value: not <span class="hljs-built_in">set</span><br>ping.path = /ping                 <span class="hljs-comment">#取消此行注释</span><br>....<br>; Default Value: pong<br>ping.response = pong              <span class="hljs-comment">#取消此行注释</span><br>:wq<br>[root@LNP ~]<span class="hljs-comment">#systemctl enable --now php-fpm</span><br><br><span class="hljs-comment">#设置nginx的配置</span><br>[root@LNP ~]<span class="hljs-comment">#vim /apps/nginx/conf.d/pc.conf</span><br>server &#123;<br>   listen 80;<br>   server_name www.magedu.org;<br>   access_log /apps/nginx/logs/access-json-www.magedu.org.log access_json;<br>   root /data/nginx/html/pc;<br>   location / &#123;<br>       <span class="hljs-comment">#root /data/nginx/html/pc;</span><br>       proxy_pass http://webserver;<br>   &#125;<br>   location ~ \.php$ &#123;<br>       root           /data/nginx/html/pc;<br>       fastcgi_pass   127.0.0.1:9000;<br>       fastcgi_index  index.php;<br>       fastcgi_param  SCRIPT_FILENAME  $document_root<span class="hljs-variable">$fastcgi_script_name</span>;<br>       include        fastcgi_params;<br>   &#125;<br>   location ~ ^/(ping|fpm_status)$ &#123;<br>       fastcgi_pass   127.0.0.1:9000;<br>       fastcgi_param  PATH_TRANSLATED $document_root<span class="hljs-variable">$fastcgi_script_name</span>;<br>       include fastcgi_params;<br>   &#125;<br>&#125;<br>:wq<br>[root@LNP ~]<span class="hljs-comment">#nginx -t</span><br>nginx: the configuration file /apps/nginx/conf/nginx.conf syntax is ok<br>nginx: configuration file /apps/nginx/conf/nginx.conf <span class="hljs-built_in">test</span> is successful<br>[root@LNP ~]<span class="hljs-comment">#nginx -s reload</span><br><br><span class="hljs-comment">#下载wordpress</span><br>[root@LNP ~]<span class="hljs-comment">#wget https://cn.wordpress.org/latest-zh_CN.tar.gz</span><br>[root@LNP ~]<span class="hljs-comment">#ls</span><br>anaconda-ks.cfg  install_nginx.sh  latest-zh_CN.tar.gz<br>[root@LNP ~]<span class="hljs-comment">#tar xf latest-zh_CN.tar.gz </span><br>[root@LNP ~]<span class="hljs-comment">#ls</span><br>anaconda-ks.cfg  install_nginx.sh  latest-zh_CN.tar.gz  wordpress<br>[root@LNP ~]<span class="hljs-comment">#mv wordpress/* /data/nginx/html/pc</span><br>[root@LNP ~]<span class="hljs-comment">#chown -R nginx. /data/nginx/html/pc</span><br></code></pre></td></tr></table></figure>

<h4 id="10-2、数据库mysql的配置"><a href="#10-2、数据库mysql的配置" class="headerlink" title="10.2、数据库mysql的配置"></a>10.2、数据库mysql的配置</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sh">[root@Rocky ~]<span class="hljs-comment">#yum -y install mysql-server</span><br>[root@Rocky ~]<span class="hljs-comment">#systemctl enable --now mysqld</span><br>Created symlink /etc/systemd/system/multi-user.target.wants/mysqld.service → /usr/lib/systemd/system/mysqld.service.<br>[root@Rocky ~]<span class="hljs-comment">#mysql</span><br>mysql&gt; create database wordpress;<br>Query OK, 1 row affected (0.01 sec)<br><br>mysql&gt; create user wordpress@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;<br>Query OK, 0 rows affected (0.01 sec)<br><br>mysql&gt; grant all on wordpress.* to wordpress@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;<br>Query OK, 0 rows affected (0.00 sec)<br><br></code></pre></td></tr></table></figure>





<p>十二、</p>
<span id="more"></span>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/12/02/tomcat%E7%BB%83%E4%B9%A0/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">tomcat练习</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/11/27/%E7%AC%AC%E4%B9%9D%E5%91%A8%E4%BD%9C%E4%B8%9A/">
                        <span class="hidden-mobile">第九周作业</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
